<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Where To Breathe</title>

    <link rel="icon" href="Images/Logo.png" type="image/x-icon" />

    <!-- Leaflet map library CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    <!-- Leaflet map library JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
    <style>
        /* Define color scheme variables for consistent styling */
        :root {
            --primary-color: #4CAF50;    /* Main green */
            --secondary-color: #8BC34A;  /* Light green */
            --accent-color: #2E7D32;     /* Dark green */
            --light-color: #E8F5E9;      /* Very light green background */
            --dark-color: #1B5E20;       /* Very dark green */
            --warning-color: #FF9800;    /* Orange for moderate warnings */
            --danger-color: #F44336;     /* Red for severe warnings */
        }
        
        /* Basic page styling */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--light-color);
            color: #333;
        }
    
        /* Main container with max width */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
    
        /* Header styling */
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px 0;
            border-radius: 10px 10px 0 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
    
        /* Header title with icon */
        header h1 {
            margin: 0;
            padding: 0 20px;
            display: flex;
            align-items: center;
        }
    
        /* Add spacing for the icon in the header */
        header h1 svg {
            margin-right: 10px;
        }
    
        /* Main content container */
        .content {
            display: flex;
            flex-direction: column;
            background-color: white;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
    
        /* Map container styling */
        .map-container {
            height: 400px;
            position: relative;
            border-bottom: 2px solid var(--light-color);
        }
        
        /* The map itself */
        .map {
            height: 100%;
            width: 100%;
            background-color: #e5f5e0;
            position: relative;
        }
    
        /* Area highlights on the map */
        .map-area {
            position: absolute;
            cursor: pointer;
            background-color: rgba(76, 175, 80, 0.3);
            border: 2px solid var(--primary-color);
            border-radius: 50%;
            transition: all 0.3s;
        }
    
        /* Hover effect for map areas */
        .map-area:hover {
            background-color: rgba(76, 175, 80, 0.5);
        }
        
        /* Selected area styling */
        .selected-area {
            background-color: rgba(76, 175, 80, 0.7) !important;
        }
        
        /* Weather widget that appears on location selection */
        .weather-widget {
            position: absolute;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            padding: 15px;
            width: 200px;
            top: 20px;
            right: 20px;
            display: none;
            z-index: 1000;
            border-left: 4px solid var(--primary-color);
        }
    
        /* Weather widget header */
        .weather-widget h3 {
            margin-top: 0;
            color: var(--dark-color);
            border-bottom: 1px solid var(--light-color);
            padding-bottom: 8px;
            margin-bottom: 10px;
        }
        
        /* Weather info container */
        .weather-info {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        /* Weather icon container */
        .weather-icon {
            width: 40px;
            height: 40px;
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    
        /* Weather details paragraph styling */
        .weather-details p {
            margin: 5px 0;
        }
        
        /* Temperature display styling */
        .weather-temp {
            font-size: 1.2em;
            font-weight: bold;
        }
        
        /* Controls section (calendar and sensitivity) */
        .controls {
            padding: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
    
        /* Container for calendar and sensitivity controls */
        .calendar-container, .sensitivity-container {
            flex: 1;
            min-width: 300px;
        }
        
        /* Section header styling */
        h2 {
            color: var(--dark-color);
            margin-top: 0;
        }
        
        /* Calendar widget styling */
        .calendar {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
    
        /* Calendar header cell styling */
        .calendar th {
            background-color: var(--secondary-color);
            color: white;
            padding: 10px;
        }
        
        /* Calendar day cell styling */
        .calendar td {
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        /* Calendar day hover effect */
        .calendar td:hover {
            background-color: var(--light-color);
        }
        
        /* Selected calendar day */
        .calendar td.selected {
            background-color: var(--primary-color);
            color: white;
        }
    
        /* Current day in calendar */
        .calendar td.today {
            font-weight: bold;
            border: 2px solid var(--secondary-color);
        }
        
        /* Unavailable dates in calendar */
        .calendar td.unavailable {
            color: #aaa;
            cursor: not-allowed;
        }
        
        /* Container for sensitivity selection buttons */
        .sensitivity-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
    
        /* Base style for sensitivity buttons */
        .sensitivity-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        /* Low sensitivity button */
        .low {
            background-color: #E8F5E9;
            color: var(--dark-color);
            border: 2px solid var(--primary-color);
        }
    
        /* Moderate sensitivity button */
        .moderate {
            background-color: #FFF8E1;
            color: #F57F17;
            border: 2px solid var(--warning-color);
        }
        
        /* High sensitivity button */
        .high {
            background-color: #FFEBEE;
            color: #B71C1C;
            border: 2px solid var(--danger-color);
        }
    
        /* Hover effect for sensitivity buttons */
        .sensitivity-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        /* Selected sensitivity button styling */
        .sensitivity-btn.selected {
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
    
        /* Results display container */
        .results {
            padding: 20px;
            margin-top: 20px;
            border-radius: 8px;
            display: none;
        }
        
        /* Good air quality results styling */
        .good {
            background-color: rgba(76, 175, 80, 0.2);
            border: 2px solid var(--primary-color);
        }
        
        /* Moderate air quality results styling */
        .moderate {
            background-color: rgba(255, 152, 0, 0.2);
            border: 2px solid var(--warning-color);
        }
    
        /* Poor air quality results styling */
        .poor {
            background-color: rgba(244, 67, 54, 0.2);
            border: 2px solid var(--danger-color);
        }
        
        /* Results title styling */
        .result-title {
            margin-top: 0;
            display: flex;
            align-items: center;
        }
        
        /* Icon spacing in results */
        .result-title svg {
            margin-right: 10px;
        }
        
        /* Footer styling */
        footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            color: var(--dark-color);
        }
    
        /* Responsive design for smaller screens */
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
            }
            
            .map-container {
                height: 300px;
            }
            
            .weather-widget {
                width: 150px;
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Main header with title and icon -->
        <header>
            <h1>
                <!-- SVG location pin icon -->
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2a8 8 0 0 0-8 8c0 5 8 12 8 12s8-7 8-12a8 8 0 0 0-8-8zm0 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"></path>
                </svg>
                Air Quality Activity Planner
            </h1>
        </header>
        
        <div class="content">
            <!-- Map container section -->
            <div class="map-container">
                <!-- The map will be initialized here -->
                <div class="map" id="map"></div>

                <!-- Weather widget that appears when a location is selected -->
                <div class="weather-widget" id="weather-widget">
                    <h3 id="weather-location">Location</h3>
                    <div class="weather-info">
                        <div class="weather-icon" id="weather-icon">
                            <!-- Weather icon will be inserted here -->
                        </div>
                        <div class="weather-details">
                            <p class="weather-temp" id="weather-temp">-- °C</p>
                            <p id="weather-desc">Weather condition</p>
                        </div>
                    </div>
                    <div class="weather-stats">
                        <p><strong>Humidity:</strong> <span id="weather-humidity">--%</span></p>
                        <p><strong>Wind:</strong> <span id="weather-wind">-- km/h</span></p>
                    </div>
                </div>
            </div>
            
            <!-- Controls section containing calendar and sensitivity options -->
            <div class="controls">
                <!-- Calendar picker -->
                <div class="calendar-container">
                    <h2>Choose a Date</h2>
                    <table class="calendar" id="calendar">
                        <thead>
                            <tr>
                                <th colspan="7" id="month-year">
                                    <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                                        <!-- Previous month button -->
                                        <button id="prev-month" style="background: none; border: none; cursor: pointer;">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M15 18l-6-6 6-6"/>
                                            </svg>
                                        </button>
                                        <!-- Next month button -->
                                        <button id="next-month" style="background: none; border: none; cursor: pointer;">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M9 18l6-6-6-6"/>
                                            </svg>
                                        </button>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <!-- Calendar days will be inserted here -->
                        <tbody id="calendar-body">
                            
                        </tbody>
                    </table>
                </div>
                
                <!-- Air quality sensitivity selector -->
                <div class="sensitivity-container">
                    <h2>Air Quality Sensitivity</h2>
                    <p>Select your sensitivity to air quality:</p>
                    <div class="sensitivity-buttons">
                        <button class="sensitivity-btn low" data-sensitivity="low">
                            Low Sensitivity
                        </button>
                        <button class="sensitivity-btn moderate" data-sensitivity="moderate">
                            Moderate
                        </button>
                        <button class="sensitivity-btn high" data-sensitivity="high">
                            High Sensitivity
                        </button>
                    </div>
                    
                    <!-- Results panel (hidden initially) -->
                    <div id="results" class="results">
                        <h2 class="result-title" id="result-title">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M12 16v-4"></path>
                                <path d="M12 8h.01"></path>
                            </svg>
                            Outdoor Activity Guide
                        </h2>
                        <p id="result-message"></p>
                        <p id="result-details"></p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Page footer -->
        <footer>
            <p>© 2025 Air Quality Activity Planner. Data provided for demonstration purposes only.</p>
        </footer>
    </div>

    <script>
        // Air Quality Index reference table for different pollutants
        const aqiTable = [
            {
                "AQI Category": "Good",
                "no2_conc": "0–40",
                "o3_conc": "0-50",
                "so2_conc": "0-100"
            },
            {
                "AQI Category": "Fair",
                "no2_conc": "41-90",
                "o3_conc": "51-100",
                "so2_conc": "101-200"
            },
            {
                "AQI Category": "Moderate",
                "no2_conc": "91-120",
                "o3_conc": "101-130",
                "so2_conc": "201-350"
            },
            {
                "AQI Category": "Poor",
                "no2_conc": "121-230",
                "o3_conc": "131-240",
                "so2_conc": "351-500"
            },
            {
                "AQI Category": "Very poor",
                "no2_conc": "231-340",
                "o3_conc": "241-380",
                "so2_conc": "501-750"
            }
        ];

        // AQI index ranges for different categories
        const AQI_Index = [
            { "AQI Category": "Good", "Index": "0-25" },
            { "AQI Category": "Fair", "Index": "25-50" },
            { "AQI Category": "Moderate", "Index": "50-75" },
            { "AQI Category": "Poor", "Index": "75-100" },
            { "AQI Category": "Very poor", "Index": "100-125" }
        ];

        
        //Gets AQI category information for a pollutant value
        function getAQICategoryInfo(value, pollutantKey) {
            for (let entry of aqiTable) {
                let range = entry[pollutantKey];
                if (!range) continue;

                range = range.replace('–', '-');
                let [minStr, maxStr] = range.split('-');
                let min = parseFloat(minStr);
                let max = parseFloat(maxStr);

                if (value >= min && value <= max) {
                    return {
                        category: entry["AQI Category"],
                        Clow: min,
                        Chigh: max
                    };
                }
            }
            return {
                category: "Out of Range",
                Clow: null,
                Chigh: null
            };
        }

        
        //Gets the index range for an AQI category
        function getAQIIndexRange(category) {
            const entry = AQI_Index.find(e => e["AQI Category"] === category);
            if (entry && entry.Index) {
                let [Ilow, Ihigh] = entry.Index.split('-').map(Number);
                return { Ilow, Ihigh };
            }
            return { Ilow: null, Ihigh: null };
        }


        // Object to store processed AQI results
        const result = {};

        
        //Loads and processes AQI data from a JSON file
        async function loadAndProcessAQI(filePath) {
            try {
                const res = await fetch(filePath);
                const data = await res.json();

                // Group data by date
                const groupedByDate = data.reduce((acc, item) => {
                    const dateObj = new Date(item.time);
                    const month = dateObj.getMonth() + 1;
                    const day = dateObj.getDate();
                    const year = dateObj.getFullYear() % 100;
                    const formattedDate = `${month}/${day}/${year}`;

                    if (!acc[formattedDate]) {
                        acc[formattedDate] = {
                            no2_conc: [],
                            o3_conc: [],
                            so2_conc: []
                        };
                    }

                    // Add pollutant values to the appropriate arrays
                    acc[formattedDate].no2_conc.push(parseFloat(item.no2_conc));
                    acc[formattedDate].o3_conc.push(parseFloat(item.o3_conc));
                    acc[formattedDate].so2_conc.push(parseFloat(item.so2_conc));
                    return acc;
                }, {});

                // Process each date's data
                for (const date in groupedByDate) {
                    const concentrations = groupedByDate[date];
                    // Calculate average concentrations
                    const avg = {
                        no2_conc: parseFloat(
                            (concentrations.no2_conc.reduce((acc, val) => acc + val, 0) / concentrations.no2_conc.length).toFixed(2)
                        ),
                        o3_conc: parseFloat(
                            (concentrations.o3_conc.reduce((acc, val) => acc + val, 0) / concentrations.o3_conc.length).toFixed(2)
                        ),
                        so2_conc: parseFloat(
                            (concentrations.so2_conc.reduce((acc, val) => acc + val, 0) / concentrations.so2_conc.length).toFixed(2)
                        )
                    };

                    const AQI_Results = [];

                    // Calculate AQI for each pollutant
                    for (const pollutantKey of ["no2_conc", "o3_conc", "so2_conc"]) {
                        const C = avg[pollutantKey];
                        const { category, Clow, Chigh } = getAQICategoryInfo(C, pollutantKey);
                        const { Ilow, Ihigh } = getAQIIndexRange(category);

                        if (Clow !== null && Chigh !== null && Ilow !== null && Ihigh !== null) {
                            // Calculate AQI value using linear interpolation formula
                            const AQI_Value = parseFloat(
                                (((Ihigh - Ilow) / (Chigh - Clow)) * (C - Clow) + Ilow).toFixed(2)
                            );

                            AQI_Results.push({
                                pollutant: pollutantKey.toUpperCase(),
                                AQI_Value,
                                category,
                                C,
                                Clow,
                                Chigh,
                                Ilow,
                                Ihigh
                            });
                        }
                    }

                    // Find maximum AQI value among all pollutants
                    if (AQI_Results.length > 0) {
                        const maxAQI = AQI_Results.reduce((max, entry) =>
                            entry.AQI_Value > max.AQI_Value ? entry : max
                        );

                        result[date] = maxAQI.AQI_Value;
                    }
                }

            } catch (error) {
                console.error(`Error fetching or processing data from ${filePath}:`, error);
            }

            return result;
        }

        
        //Loads and processes weather data from a JSON file
        async function loadAndProcessWeather(filePath) {
            try {
                const response = await fetch(filePath);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const result = {};

                // Format dates and organize data
                data.forEach(({ date, ...rest }) => {
                    const d = new Date(date);
                    const formattedDate = `${d.getMonth() + 1}/${d.getDate()}/${String(d.getFullYear()).slice(2)}`;
                    result[formattedDate] = rest;
                });

                return result;
            } catch (error) {
                console.error('Failed to load AQI data:', error);
                return {};
            }
        }


        // Data storage objects for each location's AQI data
        const Χαλκηδόνα = {};
        const Εύοσμος = {};
        const Καλαμαριά = {};
        const Νεάπολη = {};
        const Περαία = {};
        const Πυλαία = {};
        const Σίνδος = {};
        const Θέρμη = {};
        const Θεσσαλονίκη = {};
        const Ωραιόκαστρο = {};
        
        // Data storage objects for each location's weather data
        const WeatherChalkidona = {};
        const WeatherEuosmos = {};
        const WeatherKalamaria = {};
        const WeatherNeapoli = {};
        const WeatherPeraia = {};
        const WeatherPylaia = {};
        const WeatherSindos = {};
        const WeatherThermi = {};
        const WeatherThessaloniki = {};
        const WeatherWraiokastro = {};


        // Main function that runs when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', async function () {
            // Load AQI data for all locations
            Object.assign(Χαλκηδόνα, await loadAndProcessAQI('ElementsData/Chalkidona.json'));
            Object.assign(Εύοσμος, await loadAndProcessAQI('ElementsData/Euosmos.json'));
            Object.assign(Καλαμαριά, await loadAndProcessAQI('ElementsData/Kalamaria.json'));
            Object.assign(Νεάπολη, await loadAndProcessAQI('ElementsData/Neapoli.json'));
            Object.assign(Περαία, await loadAndProcessAQI('ElementsData/Peraia.json'));
            Object.assign(Πυλαία, await loadAndProcessAQI('ElementsData/Pylaia.json'));
            Object.assign(Σίνδος, await loadAndProcessAQI('ElementsData/Sindos.json'));
            Object.assign(Θέρμη, await loadAndProcessAQI('ElementsData/Thermi.json'));
            Object.assign(Θεσσαλονίκη, await loadAndProcessAQI('ElementsData/Thessaloniki.json'));
            Object.assign(Ωραιόκαστρο, await loadAndProcessAQI('ElementsData/Wraiokastro.json'));

            // Load weather data for all locations
            Object.assign(WeatherChalkidona, await loadAndProcessWeather('WeatherData/WeatherChalkidona.json'));
            Object.assign(WeatherEuosmos, await loadAndProcessWeather('WeatherData/WeatherEuosmos.json'));
            Object.assign(WeatherKalamaria, await loadAndProcessWeather('WeatherData/WeatherKalamaria.json'));
            Object.assign(WeatherNeapoli, await loadAndProcessWeather('WeatherData/WeatherNeapoli.json'));
            Object.assign(WeatherPeraia, await loadAndProcessWeather('WeatherData/WeatherPeraia.json'));
            Object.assign(WeatherPylaia, await loadAndProcessWeather('WeatherData/WeatherPylaia.json'));
            Object.assign(WeatherSindos, await loadAndProcessWeather('WeatherData/WeatherSindos.json'));
            Object.assign(WeatherThermi, await loadAndProcessWeather('WeatherData/WeatherThermi.json'));
            Object.assign(WeatherThessaloniki, await loadAndProcessWeather('WeatherData/WeatherThessaloniki.json'));
            Object.assign(WeatherWraiokastro, await loadAndProcessWeather('WeatherData/WeatherWraiokastro.json'));
            
            // App state variables
            let selectedArea = null;
            let selectedDate = null;
            let selectedSensitivity = null;
            let map = null;
            let markers = [];
            let currentMonth = new Date().getMonth();
            let currentYear = new Date().getFullYear();
            
            // DOM elements
            const mapAreas = document.querySelectorAll(".map-area");
            const weatherWidget = document.getElementById("weather-widget");
            const sensitivityButtons = document.querySelectorAll(".sensitivity-btn");

            // Weather icon SVG definitions for different weather conditions
            const weatherIcons = {
                'Sunny': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#FF9800" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`,
                'Clear': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#FF9800" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`,
                'Partly Cloudy': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="9" r="3" stroke="#FF9800"></circle><line x1="12" y1="2" x2="12" y2="4" stroke="#FF9800"></line><line x1="5.6" y1="5.6" x2="7" y2="7" stroke="#FF9800"></line><line x1="17" y1="7" x2="18.4" y2="5.6" stroke="#FF9800"></line><path d="M16 14.5A3.5 3.5 0 1 1 9.5 18H16a4 4 0 1 0 0-8h-.5" stroke="#aaaaaa"></path></svg>`,
                'Cloudy': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#aaaaaa" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"></path></svg>`,
                'Light Rain': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#4682B4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"></path><path d="M9 19 6 22"></path><path d="m13 19-2 3"></path><path d="m16 19-1 3"></path></svg>`,
                'Rain': `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#4682B4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"></path><path d="M9 19 6 22"></path><path d="m13 19-2 3"></path><path d="m16 19-1 3"></path></svg>`,
            };

            // Event listener for sensitivity selection buttons
            sensitivityButtons.forEach(button => {
                button.addEventListener("click", function() {
                // Remove selected class from all buttons
                const allButtons = document.querySelectorAll(".sensitivity-btn");
                allButtons.forEach(btn => btn.classList.remove("selected"));
                
                // Add selected class to clicked button
                button.classList.add("selected");
                
                // Update selected sensitivity
                selectedSensitivity = button.getAttribute("data-sensitivity");
                
                // Check if all selections have been made
                checkAllSelections();
            });
            });

            // Keyboard navigation for calendar (left/right arrows)
            document.addEventListener("keydown", function(event) {
                if (event.key === "ArrowLeft") {
                    navigateToPrevMonth();
                } else if (event.key === "ArrowRight") {
                    navigateToNextMonth();
                }
            });

            // Event listeners for map area selection
            mapAreas.forEach(area => {
                area.addEventListener("click", function() {
                    // Deselect previously selected area
                    if (selectedArea) {
                        selectedArea.classList.remove("selected-area");
                    }
                    
                    // Update selected area
                    selectedArea = area;
                    area.classList.add("selected-area");
                    
                    // Update weather widget with area data
                    updateWeatherWidget(area);
                    
                    // Check if all selections have been made
                    checkAllSelections();
                });
            });

            
            //Initializes the Leaflet map with markers for each area
            function initializeMap() {
                // Create map centered on Thessaloniki
                map = L.map('map').setView([40.6401, 22.9444], 10);
                
                // Add OpenStreetMap tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);
                
                // Get today's date in the required format
                const today = new Date();
                const initialDate = `${today.getMonth() + 1}/${today.getDate()}/${today.getFullYear().toString().slice(2)}`;
                
                // Define all areas with their coordinates and initial data
                const areas = [
                    { 
                        name: "Χαλκηδόνα", 
                        lat: 40.7315937, lng: 22.59874208, 
                        aqi: Θεσσαλονίκη[initialDate] !== undefined ? Θεσσαλονίκη[initialDate] : undefined, 
                        temp: WeatherChalkidona[initialDate]?.temperature || "--",
                        weather: WeatherChalkidona[initialDate]?.description || "No Data",
                        humidity: WeatherChalkidona[initialDate]?.humidity || "--",
                        wind: WeatherChalkidona[initialDate]?.wind || "--" 
                    },
                    {
                        name: "Εύοσμος",
                        lat: 40.6696845, lng: 22.91539098,
                        aqi: Εύοσμος[initialDate] !== undefined ? Εύοσμος[initialDate] : undefined,
                        temp: WeatherEuosmos[initialDate]?.temperature || "--",
                        weather: WeatherEuosmos[initialDate]?.description || "No Data",
                        humidity: WeatherEuosmos[initialDate]?.humidity || "--",
                        wind: WeatherEuosmos[initialDate]?.wind || "--"
                    },
                    {
                        name: "Καλαμαριά",
                        lat: 40.58220224, lng: 22.95315301,
                        aqi: Καλαμαριά[initialDate] !== undefined ? Καλαμαριά[initialDate] : undefined,
                        temp: WeatherKalamaria[initialDate]?.temperature || "--",
                        weather: WeatherKalamaria[initialDate]?.description || "No Data",
                        humidity: WeatherKalamaria[initialDate]?.humidity || "--",
                        wind: WeatherKalamaria[initialDate]?.wind || "--"
                    },
                    {
                        name: "Νεάπολη",
                        lat: 40.6534, lng: 22.9420,
                        aqi: Νεάπολη[initialDate] !== undefined ? Νεάπολη[initialDate] : undefined,
                        temp: WeatherNeapoli[initialDate]?.temperature || "--",
                        weather: WeatherNeapoli[initialDate]?.description || "No Data",
                        humidity: WeatherNeapoli[initialDate]?.humidity || "--",
                        wind: WeatherNeapoli[initialDate]?.wind || "--"
                    },
                    {
                        name: "Περαία",
                        lat: 40.5031, lng: 22.9296,
                        aqi: Περαία[initialDate] !== undefined ? Περαία[initialDate] : undefined,
                        temp: WeatherPeraia[initialDate]?.temperature || "--",
                        weather: WeatherPeraia[initialDate]?.description || "No Data",
                        humidity: WeatherPeraia[initialDate]?.humidity || "--",
                        wind: WeatherPeraia[initialDate]?.wind || "--"
                    },
                    {
                        name: "Πυλαία",
                        lat: 40.6009, lng: 22.9891,
                        aqi: Πυλαία[initialDate] !== undefined ? Πυλαία[initialDate] : undefined,
                        temp: WeatherPylaia[initialDate]?.temperature || "--",
                        weather: WeatherPylaia[initialDate]?.description || "No Data",
                        humidity: WeatherPylaia[initialDate]?.humidity || "--",
                        wind: WeatherPylaia[initialDate]?.wind || "--"
                    },
                    {
                        name: "Σίνδος",
                        lat: 40.670698, lng: 22.8034071,
                        aqi: Σίνδος[initialDate] !== undefined ? Σίνδος[initialDate] : undefined,
                        temp: WeatherSindos[initialDate]?.temperature || "--",
                        weather: WeatherSindos[initialDate]?.description || "No Data",
                        humidity: WeatherSindos[initialDate]?.humidity || "--",
                        wind: WeatherSindos[initialDate]?.wind || "--"
                    },
                    {
                        name: "Θέρμη",
                        lat: 40.5485251, lng: 23.01970203,
                        aqi: Θέρμη[initialDate] !== undefined ? Θέρμη[initialDate] : undefined,
                        temp: WeatherThermi[initialDate]?.temperature || "--",
                        weather: WeatherThermi[initialDate]?.description || "No Data",
                        humidity: WeatherThermi[initialDate]?.humidity || "--",
                        wind: WeatherThermi[initialDate]?.wind || "--"
                    },
                    {
                        name: "Θεσσαλονίκη",
                        lat: 40.6401, lng: 22.9444,
                        aqi: Θεσσαλονίκη[initialDate] !== undefined ? Θεσσαλονίκη[initialDate] : undefined,
                        temp: WeatherThessaloniki[initialDate]?.temperature || "--",
                        weather: WeatherThessaloniki[initialDate]?.description || "No Data",
                        humidity: WeatherThessaloniki[initialDate]?.humidity || "--",
                        wind: WeatherThessaloniki[initialDate]?.wind || "--"
                    },
                    {
                        name: "Ωραιόκαστρο",
                        lat: 40.7284342, lng: 22.91872141,
                        aqi: Ωραιόκαστρο[initialDate] !== undefined ? Σίνδος[initialDate] : undefined,
                        temp: WeatherWraiokastro[initialDate]?.temperature || "--",
                        weather: WeatherWraiokastro[initialDate]?.description || "No Data",
                        humidity: WeatherWraiokastro[initialDate]?.humidity || "--",
                        wind: WeatherWraiokastro[initialDate]?.wind || "--"
                    }
                ];
                
                // Create markers for each area on the map
                areas.forEach(area => {
                    // Determine marker color based on AQI value
                    let markerColor;
                    if (area.aqi === undefined) {
                        markerColor = "#999999"; // Gray for no data
                    } else if (area.aqi < 50) {
                        markerColor = "#4CAF50"; // Green for good
                    } else if (area.aqi < 100) {
                        markerColor = "#FF9800"; // Orange for moderate
                    } else {
                        markerColor = "#F44336"; // Red for poor
                    }
                    
                    // Create circle marker with appropriate color
                    const marker = L.circleMarker([area.lat, area.lng], {
                        color: markerColor,
                        fillColor: markerColor,
                        fillOpacity: 0.5,
                        radius: 15
                    }).addTo(map);
                    
                    // Store area data with the marker for later use
                    marker.areaData = area;
                    
                    // Add click event to select this area
                    marker.on('click', function() {
                        selectArea(marker);
                    });
                    
                    // Create popup with area information
                    const aqiText = area.aqi !== undefined ? `AQI: ${Math.round(area.aqi)}` : "AQI: No Data";
                    marker.bindPopup(`<b>${area.name}</b><br>${aqiText}<br>${area.weather}, ${area.temp}°C`);
                    
                    // Add marker to collection for later reference
                    markers.push(marker);
                });
                
                // Handle window resize to correctly display map
                window.addEventListener('resize', function() {
                    map.invalidateSize();
                });
            }
            
            
            //Handles the selection of an area on the map
            function selectArea(marker) {
                // Reset previously selected area
                if (selectedArea) {
                    selectedArea.setStyle({
                        fillOpacity: 0.5
                    });
                }
                
                // Update selected area
                selectedArea = marker;
                
                // Highlight the selected area
                selectedArea.setStyle({
                    fillOpacity: 0.8
                });
                
                // Update weather widget with selected area data
                updateWeatherWidget(selectedArea.areaData);
                
                // Check if all selections have been made to update results
                checkAllSelections();
            }

            
            //Generates the calendar for the specified month and year
            function generateCalendar(month, year) {
                const today = new Date();
                
                // Get first and last day of the month
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);

                // Update month and year display with navigation controls
                const monthNames = ["January", "February", "March", "April", "May", "June",
                                    "July", "August", "September", "October", "November", "December"];
                document.getElementById("month-year").innerHTML = `
                    ${monthNames[month]} ${year}
                    <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                        <button id="prev-month" style="background: none; border: none; cursor: pointer;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M15 18l-6-6 6-6"/>
                            </svg>
                        </button>
                        <button id="next-month" style="background: none; border: none; cursor: pointer;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M9 18l6-6-6-6"/>
                            </svg>
                        </button>
                    </div>
                    <div style="text-align: center; margin-top: 8px;">
                        <button id="today-button" style="background-color: var(--secondary-color); color: white; border: none; border-radius: 4px; padding: 2px 8px; cursor: pointer; font-size: 0.8em;">
                            Today
                        </button>
                    </div>
                `;

                // Get calendar body element and clear it
                const calendarBody = document.getElementById("calendar-body");
                calendarBody.innerHTML = "";

                // Build calendar days
                let date = 1;
                for (let i = 0; i < 6; i++) {
                    // Create a new row
                    const row = document.createElement("tr");
                    
                    // Fill row with cells for each day of the week
                    for (let j = 0; j < 7; j++) {
                        if (i === 0 && j < firstDay.getDay()) {
                            // Empty cells for days before the first of month
                            const cell = document.createElement("td");
                            cell.classList.add("unavailable");
                            row.appendChild(cell);
                        } else if (date > lastDay.getDate()) {
                            // Break when we've filled all days of the month
                            break;
                        } else {
                            // Create a cell for this day
                            const cell = document.createElement("td");
                            cell.textContent = date;
                            
                            // Store the day value for event handlers
                            const dayValue = date;
                            
                            // Highlight today's date
                            if (date === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                                cell.classList.add("today");
                            }
                            
                            // Add click event to select this date
                            cell.addEventListener("click", function() {
                                // Clear previous selection
                                const allCells = document.querySelectorAll(".calendar td");
                                allCells.forEach(c => c.classList.remove("selected"));
                                
                                // Mark this cell as selected
                                cell.classList.add("selected");
                                
                                // Update selected date
                                selectedDate = new Date(year, month, dayValue);
                                
                                // Format date for data lookup
                                const shortMonth = (month + 1);
                                const shortDay = dayValue;
                                const shortYear = year.toString().slice(2);
                                const formattedDate = `${shortMonth}/${shortDay}/${shortYear}`;
                                
                                // Update markers with data for selected date
                                updateAllMarkers(formattedDate);
                                
                                // Check if all required selections are made
                                checkAllSelections();
                            });
                            
                            // Add cell to row
                            row.appendChild(cell);
                            date++;
                        }
                    }

                    // Add row to calendar body
                    calendarBody.appendChild(row);
                    
                    // Break if we've filled all days
                    if (date > lastDay.getDate()) {
                        break;
                    }
                }

                // Add event listener for previous month button
                document.getElementById("prev-month").addEventListener("click", function() {
                    navigateToPrevMonth();
                });
                
                // Add event listener for next month button
                document.getElementById("next-month").addEventListener("click", function() {
                    navigateToNextMonth();
                });

                // Add event listener for today button
                document.getElementById("today-button").addEventListener("click", function() {
                    goToToday();
                });
            }
            

            //Updates all map markers with data for the selected date
            function updateAllMarkers(formattedDate) {
                // Update each marker with data for the selected date
                markers.forEach(marker => {
                    const locationName = marker.areaData.name;
                    let aqiValue;
                    let weatherData;
                    
                    // Get AQI and weather data for this location and date
                    switch(locationName) {
                        case "Θεσσαλονίκη":
                            aqiValue = Θεσσαλονίκη[formattedDate];
                            weatherData = WeatherThessaloniki[formattedDate];
                            break;
                        case "Σίνδος":
                            aqiValue = Σίνδος[formattedDate];
                            weatherData = WeatherSindos[formattedDate];
                            break;
                        case "Καλαμαριά":
                            aqiValue = Καλαμαριά[formattedDate];
                            weatherData = WeatherKalamaria[formattedDate];
                            break;
                        case "Νεάπολη":
                            aqiValue = Νεάπολη[formattedDate];
                            weatherData = WeatherNeapoli[formattedDate];
                            break;
                        case "Εύοσμος":
                            aqiValue = Εύοσμος[formattedDate];
                            weatherData = WeatherEuosmos[formattedDate];
                            break;
                        case "Περαία":
                            aqiValue = Περαία[formattedDate];
                            weatherData = WeatherPeraia[formattedDate];
                            break;
                        case "Πυλαία":
                            aqiValue = Πυλαία[formattedDate];
                            weatherData = WeatherPylaia[formattedDate];
                            break;
                        case "Θέρμη":
                            aqiValue = Θέρμη[formattedDate];
                            weatherData = WeatherThermi[formattedDate];
                            break;
                        case "Χαλκηδόνα":
                            aqiValue = Χαλκηδόνα[formattedDate];
                            weatherData = WeatherChalkidona[formattedDate];
                            break;
                        case "Ωραιόκαστρο":
                            aqiValue = Ωραιόκαστρο[formattedDate];
                            weatherData = WeatherWraiokastro[formattedDate];
                            break;
                        default:
                            aqiValue = undefined;
                            weatherData = null;
                    }

                    // Update marker area data with new values
                    marker.areaData.aqi = aqiValue;
                    
                    // Update weather data if available
                    if (weatherData) {
                        marker.areaData.temp = weatherData.temperature;
                        marker.areaData.weather = weatherData.description;
                        marker.areaData.humidity = weatherData.humidity;
                        marker.areaData.wind = weatherData.wind;
                    } else {
                        // Reset weather data when no data is available
                        marker.areaData.temp = "--";
                        marker.areaData.weather = "No Data";
                        marker.areaData.humidity = "--";
                        marker.areaData.wind = "--";
                    }

                    // Update marker color based on AQI value
                    let markerColor;
                    if (aqiValue === undefined) {
                        markerColor = "#999999"; // Gray for no data
                    } else if (aqiValue < 50) {
                        markerColor = "#4CAF50"; // Green for good
                    } else if (aqiValue < 100) {
                        markerColor = "#FF9800"; // Orange for moderate
                    } else {
                        markerColor = "#F44336"; // Red for poor
                    }
                    
                    // Apply new color to marker
                    marker.setStyle({
                        color: markerColor,
                        fillColor: markerColor
                    });
                    
                    // Update popup content with new data
                    const aqiText = aqiValue !== undefined ? `AQI: ${Math.round(aqiValue)}` : "AQI: No Data";
                    const weatherText = marker.areaData.weather !== "No Data" ? `${marker.areaData.weather}, ${marker.areaData.temp}°C` : "No Data, --°C";
                    marker.setPopupContent(`<b>${marker.areaData.name}</b><br>${aqiText}<br>${weatherText}`);
                });
                
                if (selectedArea && selectedDate && selectedSensitivity) {
                    if (selectedArea.areaData.aqi !== undefined) {
                        displayResults();
                    } else {
                        // Hide results panel if selected area has no data
                        const resultContainer = document.getElementById("results");
                        resultContainer.style.display = "none";
                    }
                }

                // Update weather widget if an area is selected
                if (selectedArea) {
                    updateWeatherWidget(selectedArea.areaData);
                }
            }
            

            //Navigate to the previous month in the calendar
            function navigateToPrevMonth() {
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                generateCalendar(currentMonth, currentYear);
            }
            
            
            //Navigate to the next month in the calendar
            function navigateToNextMonth() {
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                generateCalendar(currentMonth, currentYear);
            }

            
            // Navigate to today's date in the calendar
            function goToToday() {
                const today = new Date();
                currentMonth = today.getMonth();
                currentYear = today.getFullYear();
                generateCalendar(currentMonth, currentYear);

                // Select today's date cell after rendering calendar
                setTimeout(() => {
                    const todayCell = document.querySelector(".calendar td.today");
                    if (todayCell) {
                        // Clear previous selection
                        const allCells = document.querySelectorAll(".calendar td");
                        allCells.forEach(c => c.classList.remove("selected"));
                        
                        // Mark today as selected
                        todayCell.classList.add("selected");
                        selectedDate = today;
                        
                        // Format date for data lookup
                        const shortMonth = (today.getMonth() + 1);
                        const shortDay = today.getDate();
                        const shortYear = today.getFullYear().toString().slice(2);
                        const formattedDate = `${shortMonth}/${shortDay}/${shortYear}`;
                        
                        // Update markers with today's data
                        updateAllMarkers(formattedDate);
                        
                        // Check if all required selections are made
                        checkAllSelections();
                
                        // Scroll to make today's cell visible
                        todayCell.scrollIntoView({ behavior: "smooth", block: "center" });
                    }
                }, 50);
            }

            
            generateCalendar(currentMonth, currentYear);
            
            
            //Updates the weather widget with data for the selected area
            function updateWeatherWidget(area) {
                const locationName = area.name;
                const temp = area.temp;
                const weather = area.weather;
                const humidity = area.humidity;
                const wind = area.wind;
                
                // Update widget text content
                document.getElementById("weather-location").textContent = locationName;
                document.getElementById("weather-temp").textContent = `${temp}°C`;
                document.getElementById("weather-desc").textContent = weather;
                document.getElementById("weather-humidity").textContent = `${humidity}%`;
                document.getElementById("weather-wind").textContent = `${wind} km/h`;
                
                // Update weather icon
                const iconContainer = document.getElementById("weather-icon");
                iconContainer.innerHTML = weatherIcons[weather] || '';
                
                // Show the weather widget
                weatherWidget.style.display = "block";
            }
            
              //Checks if all required selections (area, date, sensitivity) have been made and displays results if they have
            function checkAllSelections() {
                // If area and date are selected but sensitivity is not, automatically select "Low Sensitivity"
                if (selectedArea && selectedDate && !selectedSensitivity) {
                    // Get the low sensitivity button
                    const lowSensitivityButton = document.querySelector(".sensitivity-btn.low");
                    if (lowSensitivityButton) {
                        // Remove selected class from all buttons
                        const allButtons = document.querySelectorAll(".sensitivity-btn");
                        allButtons.forEach(btn => btn.classList.remove("selected"));
                        
                        // Add selected class to low sensitivity button
                        lowSensitivityButton.classList.add("selected");
                        
                        // Update selected sensitivity
                        selectedSensitivity = "low";
                    }
                }
                
                // Check if all selections have been made now
                if (selectedArea && selectedDate && selectedSensitivity) {
                    if (selectedArea.areaData.aqi !== undefined) {
                        displayResults();
                    } else {
                        // Hide results panel if no data is available
                        const resultContainer = document.getElementById("results");
                        resultContainer.style.display = "none";
                    }
                } else {
                    // Hide results panel if all selections are not made
                    const resultContainer = document.getElementById("results");
                    resultContainer.style.display = "none";
                }
            }
            

            /*
            Displays the air quality assessment results based on the selected area, sensitivity level, and date
            Updates the UI with appropriate messaging and visual cues
            */
            function displayResults() {
                // Get DOM elements for result display
                const resultContainer = document.getElementById("results");
                const resultMessage = document.getElementById("result-message");
                const resultDetails = document.getElementById("result-details");
                const resultTitle = document.getElementById("result-title");
                
                // Extract data from the selected area
                const areaData = selectedArea.areaData;
                const areaName = areaData.name;
                const aqi = areaData.aqi;
                const weather = areaData.weather;
                
                // Initialize variables for result information
                let status = "";
                let message = "";
                let details = "";
                let statusColor = "";
                
                // Format the selected date for display
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                const formattedDate = selectedDate.toLocaleDateString('en-US', options);
                
                // Determine air quality status based on sensitivity level and AQI
                if (selectedSensitivity === "low") {
                    // Low sensitivity thresholds
                    if (aqi < 75) {
                        status = "good";
                        statusColor = "#4CAF50";
                        message = `<strong>${areaName}</strong> has good air quality for your planned activity on ${formattedDate}.`;
                        details = `It's a great time to be outdoors. The air quality poses no concerns.`;
                    } else if (aqi < 100) {
                        status = "moderate";
                        statusColor = "#FF9800";
                        message = `<strong>${areaName}</strong> has moderate air quality for your planned activity on ${formattedDate}.`;
                        details = `Outdoor activities are generally fine. Just be mindful of any symptoms.`;
                    } else {
                        status = "poor";
                        statusColor = "#F44336";
                        message = `<strong>${areaName}</strong> has poor air quality for your planned activity on ${formattedDate}.`;
                        details = `Consider limiting time outside. The air may cause mild discomfort.`;
                    }
                } else if (selectedSensitivity === "moderate") {
                    // Moderate sensitivity thresholds
                    if (aqi < 50) {
                        status = "good";
                        statusColor = "#4CAF50";
                        message = `<strong>${areaName}</strong> has good air quality for your planned activity on ${formattedDate}.`;
                        details = `The air is clean — a good opportunity to enjoy some time outdoors.`;
                    } else if (aqi < 75) {
                        status = "moderate";
                        statusColor = "#FF9800";
                        message = `<strong>${areaName}</strong> has moderate air quality for your planned activity on ${formattedDate}.`;
                        details = `Some may experience discomfort. Light outdoor activity is okay with caution.`;
                    } else {
                        status = "poor";
                        statusColor = "#F44336";
                        message = `<strong>${areaName}</strong> has poor air quality for your planned activity on ${formattedDate}.`;
                        details = `Not recommended to go outside. The air quality may affect breathing.`;
                    }
                } else if (selectedSensitivity === "high") {
                    // High sensitivity thresholds
                    if (aqi < 25) {
                        status = "good";
                        statusColor = "#4CAF50";
                        message = `<strong>${areaName}</strong> has good air quality for your planned activity on ${formattedDate}.`;
                        details = `Safe conditions for outdoor activities. Enjoy the fresh air.`;
                    } else if (aqi < 50) {
                        status = "moderate";
                        statusColor = "#FF9800";
                        message = `<strong>${areaName}</strong> has moderate air quality for your planned activity on ${formattedDate}.`;
                        details = `Even moderate levels may cause issues. It's safer to stay indoors.`;
                    } else {
                        status = "poor";
                        statusColor = "#F44336";
                        message = `<strong>${areaName}</strong> has poor air quality for your planned activity on ${formattedDate}.`;
                        details = `Stay indoors. The air quality is unhealthy for sensitive individuals.`;
                    }
                }
                
                // Update the result container's class and content
                resultContainer.className = "results " + status;
                resultMessage.innerHTML = message;
                resultDetails.textContent = details;
                
                // Make the result container visible
                resultContainer.style.display = "block";
                
                // Create SVG icon based on status
                let svgIcon = '';
                if (status === "good") {
                    // Checkmark icon for good status
                    svgIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="${statusColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>`;
                } else if (status === "moderate") {
                    // Alert/warning icon for moderate status
                    svgIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="${statusColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="12"></line>
                        <line x1="12" y1="16" x2="12.01" y2="16"></line>
                    </svg>`;
                } else {
                    // X icon for poor status
                    svgIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="${statusColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="15" y1="9" x2="9" y2="15"></line>
                        <line x1="9" y1="9" x2="15" y2="15"></line>
                    </svg>`;
                }
                
                // Update the result title with the appropriate icon and color
                resultTitle.innerHTML = svgIcon + " <span style='color: " + statusColor + "'>Outdoor Activity Guide</span>";
                
                // Update map markers to reflect current sensitivity setting
                updateMarkersBasedOnSensitivity(selectedSensitivity);
            }


            // Initialize the calendar with current month and year
            generateCalendar(currentMonth, currentYear);

            // Initialize the map display
            initializeMap();


            //Updates the map markers' colors based on AQI thresholds for the selected sensitivity level
            function updateMarkersBasedOnSensitivity(sensitivity) {
                markers.forEach(marker => {
                    const aqi = marker.areaData.aqi;
                    let markerColor;
                    
                    // Determine marker color based on AQI and sensitivity level
                    if (aqi === undefined) {
                        // Gray for areas with no AQI data
                        markerColor = "#999999";
                    } else if (sensitivity === "low") {
                        // Color thresholds for low sensitivity
                        if (aqi < 75) {
                            markerColor = "#4CAF50"; // Green - good
                        } else if (aqi < 100) {
                            markerColor = "#FF9800"; // Orange - moderate
                        } else {
                            markerColor = "#F44336"; // Red - poor
                        }
                    } else if (sensitivity === "moderate") {
                        // Color thresholds for moderate sensitivity
                        if (aqi < 50) {
                            markerColor = "#4CAF50"; // Green - good
                        } else if (aqi < 75) {
                            markerColor = "#FF9800"; // Orange - moderate
                        } else {
                            markerColor = "#F44336"; // Red - poor
                        }
                    } else if (sensitivity === "high") {
                        // Color thresholds for high sensitivity
                        if (aqi < 25) {
                            markerColor = "#4CAF50"; // Green - good
                        } else if (aqi < 50) {
                            markerColor = "#FF9800"; // Orange - moderate
                        } else {
                            markerColor = "#F44336"; // Red - poor
                        }
                    }
                    
                    // Apply the color to the marker
                    marker.setStyle({
                        color: markerColor,
                        fillColor: markerColor
                    });
                    
                    // Highlight the selected area marker
                    if (selectedArea === marker) {
                        marker.setStyle({
                            fillOpacity: 0.8,
                            weight: 3
                        });
                    }
                });
            }
            
        });
    </script>
</body>
</html>
